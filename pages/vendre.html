<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vendre</title>
  <link href="../assets/css/style.css" rel="stylesheet">
</head>

<body class="bg-gray-100 font-sans">
    <div id="header"></div>
    <div id="navbar"></div>

    <main class="sm:pl-72 mt-[105px] p-4 sm:p-6 ">
        <div class="flex flex-col sm:flex-row gap-4 sm:gap-6 h-full">
            <section class="w-full sm:w-1/2 space-y-4">
                <h2 class="text-xl font-bold text-darkblue mb-2 sm:mb-0">Articles disponibles</h2>
                <input type="text" id="search-input" placeholder="Rechercher un article..."
                    class="w-full px-4 py-2 border rounded shadow-sm focus:outline-none focus:ring focus:border-primary" />

                <div id="article-list"
                    class="space-y-2 overflow-y-auto h-[40vh] sm:h-[75vh] border p-2 rounded bg-white shadow-sm">
                    </div>
            </section>

            <section class="w-full sm:w-1/2 flex flex-col space-y-4">
                <h2 class="text-xl font-bold text-darkblue">D√©tail de la vente</h2>

                <div id="vente-details"
                    class="space-y-2 bg-white p-4 rounded shadow-sm border h-[30vh] sm:h-[50vh] overflow-y-auto">
                    </div>

                <div class="text-right font-bold text-lg">
                    Total : <span id="total-vente">0 $</span>
                </div>

                <div class="bg-white border p-4 rounded shadow-sm space-y-2">
                    <label for="client-search" class="block text-sm text-gray-700">Client :</label>
                    <input type="text" id="client-search" placeholder="Rechercher un client..."
                        class="w-full px-3 py-2 border rounded" />
                    <div id="client-results" class="max-h-32 overflow-y-auto text-sm text-gray-700 border border-gray-200 rounded p-1"></div>
                    <button id="btn-nouveau-client" class="text-sm text-primary hover:underline">+ Nouveau client</button>
                    <p id="client-selectionne" class="text-sm text-green-700 font-semibold hidden">Client s√©lectionn√© :
                        <span></span>
                    </p>
                </div>

                <div class="flex flex-col sm:flex-row justify-end gap-3 mt-2">
                    <button id="btn-annuler"
                        class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-700 w-full sm:w-auto">Annuler</button>
                    <button id="btn-soumettre-vente"
                        class="bg-primary text-white px-4 py-2 rounded hover:bg-orange-800 w-full sm:w-auto">Soumettre Vente</button>
                </div>
            </section>
        </div>
    </main>

    <div id="overlay" class="fixed inset-0 bg-black/30 backdrop-blur-sm z-40 hidden"></div>
    <div id="article-modal"
        class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white p-6 rounded shadow-lg w-11/12 max-w-md z-50 hidden">
        <h2 class="text-xl font-bold text-darkblue mb-4">D√©tail Article</h2>
        <div id="article-details" class="space-y-2 text-sm text-gray-700">
            <p><strong>Nom :</strong> <span id="modal-nom"></span></p>
            <p><strong>Couleur :</strong> <span id="modal-couleur"></span></p>
            <p><strong>Taille :</strong> <span id="modal-taille"></span></p>
            <p><strong>Cat√©gorie :</strong> <span id="modal-categorie"></span></p>
            <p><strong>Prix Vente :</strong> <span id="modal-prix"></span></p>
            <p><strong>Stock :</strong> <span id="modal-stock"></span></p>
        </div>

        <form id="article-form" class="mt-4 space-y-4">
            <input type="number" id="input-quantite" placeholder="Quantit√© √† vendre" min="1"
                class="w-full px-4 py-2 border rounded" />
            <input type="number" id="input-prix-recu" placeholder="Prix re√ßu unitaire" min="0" step="0.01"
                class="w-full px-4 py-2 border rounded" />
            <div class="flex justify-end gap-3">
                <button type="button" id="btn-modal-cancel"
                    class="px-4 py-2 bg-gray-400 text-white rounded">Annuler</button>
                <button type="submit"
                    class="px-4 py-2 bg-primary text-white rounded hover:bg-orange-800">Ajouter</button>
            </div>
        </form>
    </div>

    <div id="overlay-client" class="fixed inset-0 bg-black/30 backdrop-blur-sm z-40 hidden"></div>
    <div id="modal-client" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 
        bg-white rounded-lg shadow-lg z-50 w-11/12 max-w-md p-6 hidden">
        <h2 id="form-title-client" class="text-xl font-bold text-darkblue mb-4">Ajouter un client</h2>
        <form id="form-client" class="space-y-4">
            <input type="text" name="nom_client" placeholder="Nom" required class="w-full px-4 py-2 border rounded" />
            <input type="text" name="prenom_client" placeholder="Prenom" required
                class="w-full px-4 py-2 border rounded" />
            <select name="sexe" required class="w-full px-4 py-2 border rounded">
                <option value="">-- S√©lectionner le sexe --</option>
                <option value="homme">Homme</option>
                <option value="femme">Femme</option>
            </select>
            <input type="text" name="telephone" placeholder="T√©l√©phone" class="w-full px-4 py-2 border rounded" />
            <input type="text" name="adresse" placeholder="Adresse" class="w-full px-4 py-2 border rounded" />
            <div class="flex justify-end gap-3 pt-4">
                <button type="button" id="cancel-client"
                    class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Annuler</button>
                <button type="submit"
                    class="bg-primary text-white px-4 py-2 rounded hover:bg-orange-800">Ajouter</button>
            </div>
        </form>
    </div>

    <script type="module">
        import { loadNavbar } from '/assets/js/navbar.js';
        import { loadHeader } from '/assets/js/header.js';
        import { getArticles, getClients, authFetch } from '/assets/js/api.js';
        import { injectButton } from '/assets/js/utils.js'; // Cette fonction n'est pas utilis√©e ici, peut √™tre retir√©e si c'est la seule page.
        import { showNotification } from "/assets/js/notificationModal.js";
        import { showConfirmation } from "/assets/js/confirmationModal.js";

        let selectedClientId = null;
        let clients = [];
        let articles = [];
        let vente = [];
        let totalVente = 0;
        let selectedArticle = null;

        document.addEventListener("DOMContentLoaded", async () => {
            loadNavbar(); // Assurez-vous que la navbar est charg√©e en premier
            loadHeader(); // Le header √©galement
            clients = await getClients();
            articles = await getArticles();
            renderArticleList(articles);
        });

        // üîç Recherche client dynamique
        const clientInput = document.getElementById("client-search");
        const clientResults = document.getElementById("client-results");
        const clientSelectedDisplay = document.getElementById("client-selectionne");

        clientInput.addEventListener("input", () => {
            const search = clientInput.value.toLowerCase();
            const filtered = clients.filter(c =>
                c.nom_client.toLowerCase().includes(search) ||
                c.prenom_client.toLowerCase().includes(search) ||
                (c.telephone && c.telephone.includes(search)) // V√©rifier si le t√©l√©phone existe
            );

            clientResults.innerHTML = "";
            if (search.length > 0 && filtered.length > 0) { // N'afficher les r√©sultats que si recherche non vide et r√©sultats
                filtered.forEach(c => {
                    const div = document.createElement("div");
                    div.className = "p-1 cursor-pointer hover:bg-gray-100";
                    div.textContent = `${c.nom_client} ${c.prenom_client} - ${c.telephone || 'N/A'}`;
                    div.onclick = () => {
                        selectedClientId = c.id;
                        clientSelectedDisplay.querySelector("span").textContent = `${c.nom_client} ${c.prenom_client}`;
                        clientSelectedDisplay.classList.remove("hidden");
                        clientResults.innerHTML = ""; // Cacher les r√©sultats apr√®s s√©lection
                        clientInput.value = ""; // Vider l'input de recherche
                    };
                    clientResults.appendChild(div);
                });
            }
        });

        // Cacher les r√©sultats de recherche client si l'utilisateur clique en dehors
        document.addEventListener('click', (e) => {
            if (!clientInput.contains(e.target) && !clientResults.contains(e.target)) {
                clientResults.innerHTML = "";
            }
        });


        // ‚úÖ Ouvrir le modal client
        document.getElementById("btn-nouveau-client").addEventListener("click", () => {
            document.getElementById("modal-client").classList.remove("hidden");
            document.getElementById("overlay-client").classList.remove("hidden");
        });

        // ‚úÖ Fermer le modal client
        document.getElementById("cancel-client").addEventListener("click", () => {
            document.getElementById("modal-client").classList.add("hidden");
            document.getElementById("overlay-client").classList.add("hidden");
        });

        // ‚úÖ Ajouter un nouveau client
        document.getElementById("form-client").addEventListener("submit", async (e) => {
            e.preventDefault();
            const nom_client = e.target.nom_client.value;
            const prenom_client = e.target.prenom_client.value;
            const sexe = e.target.sexe.value;
            const adresse = e.target.adresse.value;
            const telephone = e.target.telephone.value;

            const payload = {
                nom_client,
                prenom_client,
                sexe,
                telephone,
                adresse
            };

            try {
                const res = await authFetch('http://127.0.0.1:8000/stock/client/new/', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    showNotification("Client ajout√© !");
                    document.getElementById("modal-client").classList.add("hidden");
                    document.getElementById("overlay-client").classList.add("hidden");

                    clients = await getClients(); // recharge la liste
                    e.target.reset(); // R√©initialiser le formulaire
                } else {
                    const data = await res.json();
                    console.error("Erreur:", data);
                    showNotification("‚ùå Erreur lors de l'ajout. " + (data.detail || JSON.stringify(data)));
                }
            } catch (error) {
                console.error(error);
                showNotification("Erreur r√©seau lors de l'ajout du client.");
            }
        });


        // üßæ Liste des articles
        const articleList = document.getElementById("article-list");
        const searchInput = document.getElementById("search-input");
        const overlay = document.getElementById("overlay");
        const modal = document.getElementById("article-modal");

        function renderArticleList(filtered = articles) {
            articleList.innerHTML = "";
            if (filtered.length === 0) {
                articleList.innerHTML = '<p class="text-gray-500 p-4">Aucun article trouv√©.</p>';
                return;
            }
            filtered.forEach(article => {
                const div = document.createElement("div");
                div.className = "p-3 border rounded hover:bg-gray-100 cursor-pointer";
                div.textContent = `${article.nom_article} (${article.quantite_en_stock} en stock)`;
                div.onclick = () => openModal(article);
                articleList.appendChild(div);
            });
        }

        // üîç Recherche d‚Äôarticles
        searchInput.addEventListener("input", () => {
            const term = searchInput.value.toLowerCase();
            const filtered = articles.filter(a =>
                a.nom_article.toLowerCase().includes(term) ||
                a.couleur.toLowerCase().includes(term) ||
                a.taille.toLowerCase().includes(term) ||
                a.categorie.toLowerCase().includes(term)
            );
            renderArticleList(filtered);
        });

        // üì¶ Modal d‚Äôajout d‚Äôarticle
        function openModal(article) {
            selectedArticle = article;
            document.getElementById("modal-nom").textContent = article.nom_article;
            document.getElementById("modal-couleur").textContent = article.couleur;
            document.getElementById("modal-taille").textContent = article.taille;
            document.getElementById("modal-categorie").textContent = article.categorie;
            document.getElementById("modal-prix").textContent = article.prix_vente_unitaire + " $";
            document.getElementById("modal-stock").textContent = article.quantite_en_stock;
            document.getElementById("input-quantite").value = "";
            document.getElementById("input-prix-recu").value = "";

            overlay.classList.remove("hidden");
            modal.classList.remove("hidden");
            // Ajuster la taille de la modale pour les petits √©crans
            // w-11/12 permet d'occuper 11/12 de la largeur de l'√©cran
            // max-w-md limite √† une largeur maximale
        }

        function closeModal() {
            overlay.classList.add("hidden");
            modal.classList.add("hidden");
        }
        document.getElementById("btn-modal-cancel").onclick = closeModal;

        // ‚ûï Ajouter un article √† la vente
        document.getElementById("article-form").addEventListener("submit", e => {
            e.preventDefault();

            const quantiteInput = document.getElementById("input-quantite");
            const prixRecuInput = document.getElementById("input-prix-recu");

            const quantite = parseInt(quantiteInput.value);
            const prixRecu = parseFloat(prixRecuInput.value);

            if (isNaN(quantite) || isNaN(prixRecu) || quantite <= 0 || prixRecu <= 0) { // prixRecu doit √™tre > 0 aussi
                showNotification("Veuillez entrer une quantit√© et un prix valides.");
                return;
            }

            if (quantite > selectedArticle.quantite_en_stock) {
                showNotification(`Stock insuffisant ! Il ne reste que ${selectedArticle.quantite_en_stock} de cet article.`);
                return;
            }

            // V√©rifier si l'article est d√©j√† dans la vente
            const existingItemIndex = vente.findIndex(item => item.id === selectedArticle.id);

            if (existingItemIndex > -1) {
                // Si l'article existe d√©j√†, mettre √† jour la quantit√© et le prix
                const existingItem = vente[existingItemIndex];
                existingItem.quantite += quantite;
                existingItem.prixRecu = prixRecu; // Mettre √† jour le prix re√ßu si diff√©rent
                existingItem.total = existingItem.quantite * existingItem.prixRecu;
            } else {
                // Sinon, ajouter le nouvel article
                const item = {
                    id: selectedArticle.id,
                    nom: selectedArticle.nom_article,
                    quantite,
                    prixRecu,
                    total: quantite * prixRecu,
                    stockInitial: selectedArticle.quantite_en_stock + quantite // Pour annuler correctement
                };
                vente.push(item);
            }

            // Mettre √† jour le stock de l'article dans la liste locale (articles)
            const articleInArticles = articles.find(a => a.id === selectedArticle.id);
            if (articleInArticles) {
                articleInArticles.quantite_en_stock -= quantite;
            }

            totalVente = vente.reduce((sum, item) => sum + item.total, 0); // Recalculer le total
            updateVenteUI();
            closeModal();
            renderArticleList(articles); // Mettre √† jour la liste des articles disponibles
        });

        // üßæ Afficher la liste d‚Äôachat
        function updateVenteUI() {
            const venteContainer = document.getElementById("vente-details");
            venteContainer.innerHTML = "";

            if (vente.length === 0) {
                venteContainer.innerHTML = '<p class="text-gray-500 p-4">Aucun article dans la vente.</p>';
            }

            vente.forEach((item, index) => {
                const div = document.createElement("div");
                div.className = "flex justify-between items-center border-b py-2 text-sm";
                div.innerHTML = `
                    <div>${item.nom}</div>
                    <div>${item.quantite} x ${item.prixRecu} $</div>
                    <div class="font-semibold">${item.total} $</div>
                    <button class="text-red-500 hover:text-red-700 ml-2" data-index="${index}" data-action="remove-item">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                venteContainer.appendChild(div);
            });

            // Ajouter les √©couteurs pour les boutons de suppression d'article
            venteContainer.querySelectorAll('[data-action="remove-item"]').forEach(button => {
                button.addEventListener('click', (e) => {
                    const indexToRemove = parseInt(e.currentTarget.dataset.index);
                    removeItemFromVente(indexToRemove);
                });
            });

            document.getElementById("total-vente").textContent = totalVente.toFixed(2) + " $"; // Formater le total
        }

        // Supprimer un article de la vente
        function removeItemFromVente(indexToRemove) {
            const itemToRemove = vente[indexToRemove];

            // R√©tablir le stock de l'article dans la liste 'articles'
            const articleInArticles = articles.find(a => a.id === itemToRemove.id);
            if (articleInArticles) {
                articleInArticles.quantite_en_stock += itemToRemove.quantite;
            }

            totalVente -= itemToRemove.total;
            vente.splice(indexToRemove, 1); // Supprimer l'article du tableau vente

            updateVenteUI(); // Mettre √† jour l'interface utilisateur de la vente
            renderArticleList(articles); // Mettre √† jour la liste des articles disponibles
        }

        // ‚ùå Annuler la vente
        document.getElementById("btn-annuler").addEventListener("click", async () => {
            const userConfirmed = await showConfirmation("Annuler la vente en cours ? Tous les articles seront retir√©s.");
            if (userConfirmed) { // showConfirmation renvoie directement true/false
                // R√©tablir le stock de tous les articles ajout√©s √† la vente
                vente.forEach(item => {
                    const originalArticle = articles.find(a => a.id === item.id);
                    if (originalArticle) {
                        originalArticle.quantite_en_stock += item.quantite;
                    }
                });

                vente = [];
                totalVente = 0;
                selectedClientId = null;

                renderArticleList(articles); // Met √† jour la liste des articles avec le stock r√©initialis√©
                updateVenteUI(); // Vide la liste de vente
                document.getElementById("client-selectionne").classList.add("hidden");
                document.getElementById("client-selectionne").querySelector("span").textContent = "";
                document.getElementById("client-search").value = "";
                showNotification("Vente annul√©e avec succ√®s.");
            }
        });

        // ‚úÖ Soumettre vente
        document.getElementById("btn-soumettre-vente").addEventListener("click", async () => {
            if (vente.length === 0) {
                showNotification("Ajoutez au moins un article pour soumettre la vente.");
                return;
            }

            if (!selectedClientId) {
                showNotification("Veuillez s√©lectionner un client.");
                return;
            }

            const userConfirmed = await showConfirmation("Confirmer la soumission de cette vente ?");
            if (!userConfirmed) {
                return; // L'utilisateur a annul√©
            }

            // Ici, vous devrez probablement obtenir l'ID du vendeur connect√©
            // Pour l'instant, je garde la valeur statique (5), mais pensez √† la dynamiser.
            const vendeurId = 5; // Remplacez par l'ID r√©el du vendeur connect√©

            const payload = {
                client: selectedClientId,
                vendeur: vendeurId,
                articles: vente.map(item => ({
                    article: item.id,
                    quantite: item.quantite,
                    prix_unitaire_recu: item.prixRecu
                }))
            };

            try {
                const response = await authFetch("http://127.0.0.1:8000/stock/vente/new/", {
                    method: "POST",
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const err = await response.json();
                    console.error("Erreur API lors de la soumission de la vente:", err);
                    showNotification("Une erreur s'est produite lors de la soumission. " + (err.detail || JSON.stringify(err)));
                    return;
                }

                showNotification("Vente enregistr√©e avec succ√®s !");
                // R√©initialiser l'√©tat de la page apr√®s une vente r√©ussie
                vente = [];
                totalVente = 0;
                selectedClientId = null;

                document.getElementById("vente-details").innerHTML = "";
                document.getElementById("total-vente").textContent = "0 $";
                document.getElementById("client-selectionne").classList.add("hidden");
                document.getElementById("client-selectionne").querySelector("span").textContent = "";
                document.getElementById("client-search").value = "";

                // Recharger les articles pour refl√©ter les quantit√©s finales apr√®s vente
                articles = await getArticles();
                renderArticleList(articles);

            } catch (error) {
                console.error("Erreur r√©seau ou autre lors de la soumission de la vente :", error);
                showNotification("√âchec de la soumission de la vente en raison d'un probl√®me r√©seau.");
            }
        });
    </script>
</body>

</html>